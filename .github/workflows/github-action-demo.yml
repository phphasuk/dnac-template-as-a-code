name: GitHub Actions Demo
on: [push]
env:
  DNAC_PASSWORD: ${{ secrets.DNAC_PASSWORD }}
  WEBEX_API_NOTIFICATION_TOKEN: ${{ secrets.WEBEX_API_NOTIFICATION_TOKEN }}
  DEBUG: "--debug"
jobs:
  validate:
    runs-on: self-hosted
    name: validate
    environment: staging
    steps:
      - uses: actions/checkout@v2
      - run: scripts/validate.py
  provision-prod:
    runs-on: self-hosted
    name: provision-prod
    environment: production
    steps:
      - run: scripts/provision_templates.py --config ${{ secrets.CONFIG_YAML }} --template_dir ${{ secrets.TEMPLATE_DIR }} --results results-1-provision.json ${{ env.DEBUG }}
      - uses: actions/upload-artifact@v2
        with:
          name: results-1-provision.json
          path: results-1-provision.json
    needs: validate
  preview-template-prod:
    runs-on: self-hosted
    name: preview-template-prod
    environment: production
    steps:
      - run: scripts/preview_templates.py --config ${{ secrets.CONFIG_YAML }} --outfile template-preview.txt --deploy_dir ${{ secrets.DEPLOY_DIR }} ${{ env.DEBUG }}
      - uses: actions/upload-artifact@v2
        with:
          name: template-preview.txt
          path: template-preveiw.txt
  deploy-prod:
    runs-on: self-hosted
    name: deploy-prod
    steps:
      - run: scripts/vars.sh
      - run: echo "test"
    needs: [validate, provision-prod]
  test-prod:
    runs-on: self-hosted
    name: test-prod
    steps:
      - run: scripts/vars.sh
      - run: echo "test"
    needs: [validate, provision-prod, deploy-prod]
  notify_success:
    runs-on: self-hosted
    name: notify_success
    if: success()
    steps:
      - run: scripts/vars.sh
      - run: echo "test success"
    needs: [validate, provision-prod, deploy-prod, test-prod]
  notify_failure:
    runs-on: self-hosted
    name: notify_failure
    if: failure()
    steps:
      - run: scripts/vars.sh
      - run: echo "test failure"
    needs: [validate, provision-prod, deploy-prod, test-prod]
